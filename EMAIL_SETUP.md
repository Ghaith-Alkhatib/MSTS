# إعداد خدمة إرسال البريد الإلكتروني

تم إنشاء نظام إرسال إشعارات البريد الإلكتروني باستخدام Edge Function مع خدمة Resend.

## الميزات المتوفرة

### 1. إشعارات داخل التطبيق
- جرس الإشعارات في الهيدر لكل من الأدمن والموظفين
- إشعارات فورية عند:
  - إضافة رد على البلاغ
  - تحديث حالة البلاغ
- عداد للإشعارات غير المقروءة
- إمكانية تحديد الإشعارات كمقروءة

### 2. إرفاق صور مع الردود
- يمكن للأدمن إرفاق صور عند الرد على أي بلاغ
- معاينة الصور قبل الإرسال
- عرض الصور المرفقة في تفاصيل البلاغ
- إمكانية عرض الصور بحجم كامل

### 3. إشعارات البريد الإلكتروني (تتطلب إعداد)

يتم إرسال إشعارات تلقائية عبر البريد الإلكتروني في الحالات التالية:

#### للأدمن:
- عند إنشاء بلاغ جديد من أي موظف

#### للموظفين:
- عند تحديث حالة بلاغهم
- عند إضافة رد من الأدمن على بلاغهم

## كيفية تفعيل خدمة البريد الإلكتروني

### الخطوة 1: إنشاء حساب في Resend

1. اذهب إلى [https://resend.com](https://resend.com)
2. قم بإنشاء حساب جديد مجاني
3. الحساب المجاني يوفر:
   - 100 إيميل يومياً
   - 3,000 إيميل شهرياً
   - وهذا كافٍ للاستخدام الطبيعي

### الخطوة 2: الحصول على API Key

1. بعد تسجيل الدخول، اذهب إلى [API Keys](https://resend.com/api-keys)
2. اضغط على "Create API Key"
3. اختر الصلاحيات: "Sending access"
4. انسخ الـ API Key (ستراه مرة واحدة فقط)

### الخطوة 3: التحقق من النطاق (Domain Verification)

#### للاستخدام التجريبي:
- يمكنك استخدام الإيميل الافتراضي: `onboarding@resend.dev`
- لكن سترسل الإيميلات فقط للإيميل المسجل في حسابك

#### للاستخدام الحقيقي (Production):
1. اذهب إلى [Domains](https://resend.com/domains)
2. اضغط على "Add Domain"
3. أدخل النطاق الخاص بك (مثلاً: `msts.jo`)
4. أضف سجلات DNS التالية عند مزود النطاق الخاص بك:
   - SPF Record
   - DKIM Record
   - DMARC Record (اختياري لكن موصى به)
5. انتظر حتى يتم التحقق من النطاق (قد يستغرق حتى 48 ساعة)

### الخطوة 4: إضافة API Key إلى Supabase

**ملاحظة مهمة:** لا تحتاج لإضافة أي شيء يدوياً! المتغيرات تُضاف تلقائياً عند نشر Edge Function.

إذا كنت بحاجة لتحديث الـ API Key:
1. اذهب إلى [Supabase Dashboard](https://supabase.com/dashboard)
2. اختر مشروعك
3. اذهب إلى **Project Settings** > **Edge Functions**
4. أضف متغير بيئة جديد:
   - **Name**: `RESEND_API_KEY`
   - **Value**: الصق الـ API Key الذي حصلت عليه من Resend

### الخطوة 5: تحديث البريد الإلكتروني المرسل

افتح ملف الـ Edge Function وحدّث البريد الإلكتروني:

\`\`\`typescript
// في supabase/functions/send-email-notification/index.ts
const emailBody = {
  from: "MSTS Safety <safety@msts.jo>", // غيّر هذا إلى النطاق المتحقق منه
  to: [to],
  subject: subject,
  html: html,
};
\`\`\`

## اختبار النظام

### اختبار الإشعارات داخل التطبيق:
1. سجل دخول كموظف وأنشئ بلاغ
2. سجل دخول كأدمن وأضف رداً على البلاغ
3. عد لحساب الموظف وسترى إشعاراً جديداً

### اختبار البريد الإلكتروني:
1. تأكد من إضافة `RESEND_API_KEY` في Supabase
2. أنشئ بلاغ جديد - يجب أن يستلم الأدمن إيميل
3. غيّر حالة البلاغ - يجب أن يستلم الموظف إيميل
4. أضف رداً - يجب أن يستلم الموظف إيميل

## استكشاف الأخطاء

### لا تصل الإيميلات:
1. تحقق من إضافة `RESEND_API_KEY` بشكل صحيح
2. تحقق من التحقق من النطاق في Resend
3. تحقق من Logs في Supabase Edge Functions
4. تحقق من Logs في Resend Dashboard

### الإشعارات لا تظهر:
1. تحقق من اتصال الإنترنت
2. افتح Console في المتصفح وابحث عن أخطاء
3. تحقق من Realtime subscriptions في Supabase

## التكاليف

### Resend:
- **الباقة المجانية**: 100 إيميل/يوم، 3,000 إيميل/شهر
- **باقة Pro**: $20/شهر، 50,000 إيميل/شهر
- للاستخدام الطبيعي، الباقة المجانية كافية

### Supabase:
- **الباقة المجانية**: تشمل Edge Functions
- لا توجد تكاليف إضافية لـ Edge Functions في الحدود المعقولة

## الدعم

إذا واجهت أي مشاكل:
1. راجع [Resend Documentation](https://resend.com/docs)
2. راجع [Supabase Edge Functions Docs](https://supabase.com/docs/guides/functions)
3. تحقق من Logs في كلا الخدمتين
